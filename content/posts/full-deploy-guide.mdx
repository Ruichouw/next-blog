---
title: 'ğŸš€ å…³äºnextåšå®¢éƒ¨ç½²çš„ä¸€äºŒäº‹'
date: '2025-02-07'
tags:
  - éƒ¨ç½²
  - Node.js
  - Next.js
  - SSH
  - GitHub
  - pm2
  - Linux
summary: 'æœ€å®Œæ•´çš„ Next.js éƒ¨ç½²æŒ‡å—ï¼šè¦†ç›– HTTPS/SSH æ‹‰å–ä»£ç ã€æœåŠ¡å™¨ç¯å¢ƒæ­å»ºã€pm2 ç®¡ç†è¿›ç¨‹ã€SSH å…å¯†ã€æœ¬åœ°æ„å»ºä¸€é”®éƒ¨ç½²è„šæœ¬ã€scp ä¸Šä¼ ã€ç”Ÿäº§ä¾èµ–å®‰è£…ç­‰å…¨éƒ¨ç»†èŠ‚ã€‚'
---

# è¿œç¨‹æœåŠ¡å™¨æ‹‰å–githubä»£ç çš„æ–¹å¼

## httpså½¢å¼

æ¯æ¬¡éƒ½éœ€è¦æä¾›ç”¨æˆ·åå’Œå¯†ç ï¼ˆtokenï¼‰

tokenéœ€è¦åˆ°githubçš„è®¾ç½®-å¼€å‘è€…è®¾ç½®ä¸­æ–°å»ºä¸€ä¸ªtoken
![è¯´æ˜](https://cdn.nlark.com/yuque/0/2025/png/44457882/1765202969404-e01ae44c-2194-46c5-8690-925a645a5bce.png)

---

æœ‰ä¸ªé—®é¢˜ï¼Œä¸ºä»€ä¹ˆæˆ‘æœ¬åœ°çš„ç”µè„‘æ¯æ¬¡ç”¨httpsåªéœ€è¦è¾“å…¥ä¸€æ¬¡ç”¨æˆ·åå’Œå¯†ç ï¼Œåé¢å°±éƒ½ä¸ç”¨äº†ï¼Œä¸ºä»€ä¹ˆæœåŠ¡å™¨æ¯æ¬¡éƒ½éœ€è¦ï¼Ÿ

> å¾®è½¯çš„ **Git Credential Managerï¼ˆGCMï¼‰**ã€‚  
> å®ƒä¼šåœ¨ç¬¬ä¸€æ¬¡ç”¨ HTTPS è®¿é—® GitHub æ—¶å¼¹çª—è®©ä½ è¾“å…¥è´¦å·/å¯†ç ï¼Œä¹‹åæŠŠä½ çš„å‡­æ®å®‰å…¨å­˜å‚¨åœ¨ï¼š
>
> - Windows å‡­æ®ç®¡ç†å™¨ï¼ˆCredential Managerï¼‰
> - è·¯å¾„ï¼šæ§åˆ¶é¢æ¿ â†’ ç”¨æˆ·è´¦æˆ· â†’ å‡­æ®ç®¡ç†å™¨ â†’ Windows å‡­æ®
>
> é‡Œé¢ä½ èƒ½æ‰¾åˆ°ç±»ä¼¼ï¼š
>
> `git:https://github.com`
>
> **Git å°±ä¼šè‡ªåŠ¨è¯»å–è¿™é‡Œçš„è®°å½•ï¼Œæ‰€ä»¥ä½ å®Œå…¨ä¸ç”¨å†è¾“å…¥å¯†ç ã€‚**
>
> æœåŠ¡å™¨ä¸Šä½¿ç”¨çš„æ˜¯çº¯å‘½ä»¤è¡Œ Gitï¼Œæ²¡æœ‰ GUIï¼Œ**æ²¡æœ‰å¼¹çª—ï¼Œæ²¡æœ‰ Windows Credential Managerã€‚ é™¤éä½ æ‰‹åŠ¨å¼€å¯å‡­æ®ç¼“å­˜ï¼Œä½†è¿™ä¼šæŠŠ token ä»¥æ˜æ–‡ä¿å­˜ï¼Œä¸å®‰å…¨ã€‚**

## sshå½¢å¼

### 1. åœ¨æœåŠ¡å™¨ä¸Šç”Ÿæˆ SSH Key

```bash
ssh-keygen -t ed25519 -C "hcss-ecs-ec69 deploy"
```

ä¹‹åæ‰“å°å…¬é’¥ï¼š

```bash
cat ~/.ssh/id_ed25519.pub
```

è¾“å‡ºå†…å®¹ç±»ä¼¼ï¼š

```bash
ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIxxxxxx... hcss-ecs-ec69 deploy
```

---

### 2. æŠŠå…¬é’¥æ·»åŠ åˆ° GitHub

GitHub â†’ Settings â†’ SSH and GPG keys â†’ New SSH key

---

### 3. æµ‹è¯• SSH æ˜¯å¦é…ç½®æˆåŠŸ

```bash
ssh -T git@github.com
```

ç¡®è®¤æç¤ºè¾“å…¥ **yes**ã€‚  
è‹¥è¾“å‡ºï¼š

```bash
You've successfully authenticated, but GitHub does not provide shell access.
```

å³æˆåŠŸã€‚

---

### 4. æŠŠä»“åº“ remote ä¿®æ”¹æˆ SSH ç‰ˆæœ¬

```bash
cd /root/apps/my-blog
git remote -v
git remote set-url origin git@github.com:Ruichouw/next-blog.git
git pull origin main
```

---

# æœåŠ¡å™¨å®‰è£…nvm,node,pnpmæ­¥éª¤

## å®‰è£…nvm

```bash
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.0/install.sh | bash
source ~/.bashrc
nvm -v
```

## å®‰è£…nodeï¼Œnpm ,pnpm

```bash
nvm install 22
nvm use 22
npm -v
npm install -g pnpm
pnpm -v
```

---

# åœ¨æœåŠ¡å™¨ä¸Šå¯åŠ¨é¡¹ç›®å¹¶ç”¨pm2ç®¡ç†é¡¹ç›®è¿›ç¨‹

å®‰è£…ä¾èµ–ï¼š

```bash
cd ~/apps/my-blog
pnpm install
```

æ‰“åŒ…ï¼š

```bash
pnpm build
pnpm start
```

æ›´æ–°ä»£ç ï¼š

```bash
git pull origin main
```

å®‰è£… pm2ï¼š

```bash
pnpm add -g pm2
pm2 -v
```

ä½¿ç”¨ pm2 ç®¡ç†ï¼š

```bash
pm2 start pnpm --name my-blog -- start
pm2 save
pm2 startup
pm2 status
```

---

# å®ç°æœ¬åœ°git bashå…å¯†ç™»å½•è¿œç¨‹æœåŠ¡å™¨

## æœ¬åœ°æ‰“å°å…¬é’¥

```bash
cat ~/.ssh/id_rsa.pub
```

å¤åˆ¶æ•´è¡Œï¼Œä» `ssh-rsa AAAA...` å¼€å§‹ã€‚

## æœåŠ¡å™¨é…ç½®

```bash
mkdir -p ~/.ssh
chmod 700 ~/.ssh
nano ~/.ssh/authorized_keys
chmod 600 ~/.ssh/authorized_keys
```

## æµ‹è¯•

```bash
ssh user@server_ip
```

---

# å®ç°æœ¬åœ°æ„å»ºæ‰“åŒ…+æœåŠ¡å™¨è¿è¡Œçš„ä¸€é”®éƒ¨ç½²è„šæœ¬

ç”±äºæœåŠ¡å™¨æ€§èƒ½å·®ï¼Œæœ¬åœ°æ„å»º â†’ scp ä¸Šä¼  â†’ æœåŠ¡å™¨è§£å‹éƒ¨ç½²æ›´å¿«ã€‚

æµç¨‹ï¼š

- æœ¬åœ° `pnpm build`
- æ‰“åŒ… `.next`
- ä¸Šä¼  `.tar.gz`
- æœåŠ¡å™¨æ‰§è¡Œ `server-deploy.sh`
- åˆ é™¤æ—§ `.next` â†’ è§£å‹ â†’ å®‰è£…ä¾èµ– â†’ pm2 reload

---

# æœ¬åœ° deploy.sh

```bash
#!/bin/bash
set -e

LOCAL_PROJECT_DIR="/d/FontCode/blog/my-blog"
REMOTE_USER="root"
REMOTE_HOST="110.41.19.112"
REMOTE_DIR="/root/apps/my-blog"
TAR_NAME="build-artifact.tar.gz"
GIT_BRANCH="main"

cd "$LOCAL_PROJECT_DIR"
git pull origin "$GIT_BRANCH"

pnpm install
pnpm build

rm -f "$TAR_NAME"

tar czf "$TAR_NAME"   .next   package.json   pnpm-lock.yaml   next.config.*   public

scp "$TAR_NAME" "$REMOTE_USER@$REMOTE_HOST:$REMOTE_DIR/$TAR_NAME"

ssh "$REMOTE_USER@$REMOTE_HOST" "cd $REMOTE_DIR && ./server-deploy.sh"

echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
```

---

# æœåŠ¡å™¨ server-deploy.sh

```bash
#!/bin/bash
set -e

export NVM_DIR="/root/.nvm"
source "$NVM_DIR/nvm.sh"

APP_DIR="/root/apps/my-blog"
PM2_APP_NAME="my-blog"
TAR_NAME="build-artifact.tar.gz"
PNPM="/root/.nvm/versions/node/v22.21.1/bin/pnpm"

cd "$APP_DIR"

if [ ! -f "$TAR_NAME" ]; then
  echo "âŒ æ‰¾ä¸åˆ° $TAR_NAME"
  exit 1
fi

rm -rf .next

tar xzf "$TAR_NAME"

$PNPM install --prod --frozen-lockfile

pm2 reload "$PM2_APP_NAME"

rm -f "$TAR_NAME"

echo "âœ… æœåŠ¡å™¨éƒ¨ç½²å®Œæˆ $(date)"
```

---

# åç»­éƒ¨ç½²æµç¨‹

æ‰“å¼€ Git Bashï¼š

```bash
./deploy.sh
```

ğŸ‰ å®Œæ•´è‡ªåŠ¨éƒ¨ç½²ã€‚
